<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pekerjaan Harian v2.2</title> <!-- Judul diubah -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hidden { display: none; }
    .opacity-0 { opacity: 0; }
    .transition-all {
      transition-property: all;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 300ms;
    }
    /* Sembunyikan panah default di input number */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    /* Style untuk panah dropdown yang berputar */
    .rotate-180 {
        transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50"> <!-- Latar belakang lebih segar -->

  <!-- 0. Peringatan Konfigurasi -->
  <div id="config-warning" class="hidden flex items-center justify-center h-screen bg-red-100 p-8">
    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-2xl font-bold text-red-700 mb-4">Konfigurasi Diperlukan</h1>
      <p class="text-gray-700">
        Harap salin URL Aplikasi Web dari Google Apps Script dan tempelkan ke variabel
        <code class="bg-gray-200 p-1 rounded">GAS_WEB_APP_URL</code> di dalam tag &lt;script&gt; file HTML ini.
      </p>
    </div>
  </div>

  <!-- 1. Indikator Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[99]">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p id="loading-message" class="mt-4 text-gray-700 font-medium">Memuat Aplikasi...</p>
    </div>
  </div>

  <!-- 2. Halaman Login -->
  <div id="login-view" class="hidden flex items-center justify-center min-h-screen bg-gray-50 p-4"> <!-- BG diubah -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
        Joblist dan Target Harian
      </h1>
      
      <form id="login-form">
        <div class="mb-4">
          <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input 
            type="text" 
            id="login-username"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
            required
          />
        </div>
        <div class="mb-6">
          <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <div class="relative">
            <input 
              type="password" 
              id="login-password"
              class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
              required
            />
            <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
              <svg class="eye-icon-open h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M247.31,124.76c-5.46-9.4-42.17-68.4-119.31-68.4S14.15,115.36,8.69,124.76a8,8,0,0,0,0,6.48c5.46,9.4,42.17,68.4,119.31,68.4S241.85,134.16,247.31,131.24A8,8,0,0,0,247.31,124.76ZM128,192c-35.3,0-64-28.7-64-64s28.7-64,64-64,64,28.7,64,64S163.3,192,128,192Zm0-80a16,16,0,1,0,16,16A16,16,0,0,0,128,112Z"></path></svg>
              <svg class="eye-icon-closed h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M208.82,187.18l-19.49-19.49a80.3,80.3,0,0,0-23-11.33,16,16,0,0,0-15.82,1.32l-10.37-10.37a48,48,0,0,1-50.28,0L79.14,136.6A80,80,0,0,0,46.53,158L29.35,175.14a8,8,0,0,0,11.32,11.32L58.82,168.3A125.53,125.53,0,0,0,128,192a124.1,124.1,0,0,0,65.3-21.3l21.9,21.9a8,8,0,0,0,11.32-11.32ZM128,176a64,64,0,0,1-53.53-27.1,8,8,0,0,0-12.2-2.31L47.18,161.68C60.46,177.19,92.34,192.54,128,192.6c3.2,0,6.39,0,9.57-.14l-11-11A64.18,64.18,0,0,1,128,176ZM167,144.15l-10.28-10.28a16,16,0,0,0-21.4-1.23,32,32,0,0,0-28.71-28.71,16,16,0,0,0-1.23-21.4L95.1,72.25A64.11,64.11,0,0,1,128,80a64,64,0,0,1,39,112.15ZM144,128a16,16,0,1,1-16-16A16,16,0,0,1,144,128Zm87.31-2.76c-5.46-9.4-42.17-68.4-119.31-68.4-23.3,0-44.49,6.7-62.59,17.71L34.3,61.35A8,8,0,0,0,23,72.67l17.18,17.18,0,0L59.09,108.76a8,8,0,0,0,12.2,2.31A64,64,0,0,1,128,112a16,16,0,0,0,1.18,0l12.14-1.51a15.91,15.91,0,0,0,5-2.61l10.2,10.2a32.06,32.06,0,0,0-3,17.92,16,16,0,0,0,1.23,21.4l10.28,10.28a64.11,64.11,0,0,1-39,12.15,63.53,63.53,0,0,1-11.37-1.1L96.26,176.4A80.31,80.31,0,0,0,128,184a79.4,79.4,0,0,0,46.33-14.47l18.52,18.52L208,203.21a125.53,125.53,0,0,0,30.34-21.84l.05,0C253.49,166,256.3,161,247.31,131.24A8,8,0,0,0,247.31,125.24Z"></path></svg>
            </button>
          </div>
        </div>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
          <!-- Pesan error akan diisi oleh JS -->
        </div>

        <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-300">
          Login
        </button>
      </form>

      <div class="text-center mt-6">
        <p class="text-sm text-gray-600">
          Belum punya akun? Hubungi pak Erdi.
        </p>
      </div>
    </div>
  </div>

  <!-- 3. Halaman Aplikasi Utama -->
  <div id="app-view" class="hidden flex h-screen"> <!-- Tata letak utama diubah -->
    
    <!-- Menu Kiri (Sidebar) -->
    <aside id="main-sidebar" class="w-64 bg-slate-900 text-white p-6 flex-col shadow-lg hidden md:flex"> <!-- BG diubah, ID ditambah -->
      <div class="flex justify-between items-center mb-8">
        <!-- Header Sidebar Baru -->
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 text-transparent bg-clip-text">
          Joblist dan Target Harian
        </h2>
      </div>

      <!-- Navigasi dipindahkan ke div terpisah untuk scroll jika perlu -->
      <nav id="sidebar-nav" class="flex-1 space-y-2 overflow-y-auto">
        
        <!-- === MENU USER === -->
        <div id="user-menu" class="hidden">
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2">Dashboard</h3>
          <button data-view="userDashboard" class="sidebar-button w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 bg-indigo-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V88H40V56ZM40,200V104H216V200Z"></path></svg>
            Dashboard Tugas Harian
          </button>

          <!-- === PERUBAHAN: TUGAS MANDIRI (DROPDOWN) === -->
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2">Tugas Mandiri</h3>
          
          <!-- Tombol Utama (Toggle) -->
          <button id="toggle-tugas-mandiri" class="sidebar-button-toggle w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center justify-between gap-3">
            <span class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M224,64H192V48a16,16,0,0,0-16-16H80A16,16,0,0,0,64,48V64H32A16,16,0,0,0,16,80v40a16,16,0,0,0,16,16h8v64a16,16,0,0,0,16,16H184a16,16,0,0,0,16-16V136h8a16,16,0,0,0,16-16V80A16,16,0,0,0,224,64ZM80,48H176V64H80ZM184,208H72V128h40a16,16,0,0,0,16-16V80h16v32a16,16,0,0,0,16,16h24Z"></path></svg>
              Tugas Mandiri
            </span>
            <!-- Panah kecil untuk indikator dropdown -->
            <svg id="arrow-tugas-mandiri" class="h-5 w-5 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>

          <!-- Sub-menu yang bisa disembunyikan -->
          <div id="submenu-tugas-mandiri" class="hidden pl-7 space-y-1 transition-all">
            <button data-view="packing" class="sidebar-button w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 text-sm">
              Packing
            </button>
            <button data-view="retur" class="sidebar-button w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 text-sm">
              Retur
            </button>
            <button data-view="inbound" class="sidebar-button w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 text-sm">
              Inbound
            </button>
            <button data-view="perapian" class="sidebar-button w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 text-sm">
              Perapian
            </button>
            <button data-view="urgent" class="sidebar-button w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 text-sm">
              Urgent
            </button>
          </div>
          <!-- === AKHIR PERUBAHAN DROPDOWN === -->
          

          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mt-6 mb-2">Laporan</h3>
          <button data-view="laporan" class="sidebar-button w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM128,184a12,12,0,1,1,12-12A12,12,0,0,1,128,184Zm40-84.82-53.3,53.3a8,8,0,0,1-11.32,0L70,119.18A8,8,0,0,1,81.3,108L98.5,125.17l48-48A8,8,0,0,1,168,99.18Z"></path></svg>
            Hasil Pekerjaan
          </button>
        </div>

        <!-- === MENU ADMIN === -->
        <div id="admin-menu" class="hidden">
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2">Menu Admin</h3>
          <button data-view="adminDashboard" class="sidebar-button w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3 bg-indigo-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V88H40V56ZM40,200V104H216V200Z"></path></svg>
            Admin Dashboard
          </button>
          <button data-view="assignTask" class="sidebar-button w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M224,48H184V32a8,8,0,0,0-8-8H80a8,8,0,0,0-8,8V48H32a8,8,0,0,0-8,8V216a8,8,0,0,0,8,8H224a8,8,0,0,0,8-8V56A8,8,0,0,0,224,48ZM88,40h80V80H88ZM216,208H40V64H80v16a8,8,0,0,0,8,8h80a8,8,0,0,0,8-8V64h40Z"></path></svg>
            Beri Tugas Baru
          </button>
          
          <button data-view="taskApproval" class="sidebar-button w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition duration-200 font-medium flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M168,88a8,8,0,0,1-8,8H96a8,8,0,0,1-8-8V40a8,8,0,0,1,8-8h64a8,8,0,0,1,8,8ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-40,1.75a8,8,0,0,0-8.83-7.92,80,80,0,1,0-80.34,0A8,8,0,0,0,96,129.75a103.11,103.11,0,0,0-23.3,47.41,8,8,0,0,0,15.86,2.68,87.11,87.11,0,0,1,80.88,0,8,8,0,0,0,15.86-2.68A103.11,103.11,0,0,0,192,129.75Z"></path></svg>
            Persetujuan Tugas
          </button>
          
        </div>
      </nav>

      <!-- Info User & Logout (Desktop) -->
      <!-- DIV INI DIHAPUS, dipindah ke header atas -->
      
    </aside>

    <!-- Panel Kanan (Header + Konten) -->
    <div class="flex-1 flex flex-col h-screen">
      
      <!-- Header Atas (BARU) -->
      <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10">
        <!-- Tombol Sync Pindah ke sini -->
        <button id="sync-button" title="Sinkronkan Data" class="p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M232.83,141.66A8,8,0,0,1,224,144H211.45a88.08,88.08,0,0,1-150.9,0H32a8,8,0,0,1-8-8,8.22,8.22,0,0,1,6.37-7.9,8,8,0,0,1,9.53,6.23A72.1,72.1,0,0,0,128,200a72,72,0,0,0,71.9-63.67,8,8,0,0,1,9.53-6.23A8.22,8.22,0,0,1,216,136h8A8,8,0,0,1,232.83,141.66ZM44.55,112H72a8,8,0,0,0,0-16H44.55a88.08,88.08,0,0,1,150.9,0H224a8,8,0,0,0,0,16h-27.45a72.1,72.1,0,0,0-137,0Z"></path></svg>
        </button>
        
        <!-- Tombol Buka Menu Mobile -->
        <button id="mobile-menu-button" class="md:hidden p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,88H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>
        </button>
        
        <!-- Tombol Profil/Logout (Baru) -->
        <div id="user-profile-menu" class="relative hidden md:block"> <!-- Sembunyikan di mobile dulu -->
          <button id="user-menu-button" class="flex items-center space-x-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
            <span id="user-username-display" class="font-medium text-sm text-gray-700">Memuat...</span>
            <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216ZM88,104a40,40,0,1,1,40,40A40,40,0,0,1,88,104Zm89.41,72.38a64.09,64.09,0,0,0-102.82,0,8,8,0,1,0,12.82,8A48.07,48.07,0,0,1,164,168.16a8,8,0,0,0,13.41,6.22Z"></path></svg>
          </button>
          <div id="logout-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-20">
            <div class="p-3 border-b">
              <p class="text-sm font-medium text-gray-800 truncate" id="user-username-dropdown">Memuat...</p>
              <p class="text-xs text-indigo-500 capitalize" id="user-role-dropdown">role</p>
            </div>
            <button id="logout-button" class="w-full text-left px-3 py-2 text-sm text-red-500 hover:bg-gray-100 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M112,24a8,8,0,0,1,8,8V128a8,8,0,0,1-16,0V32A8,8,0,0,1,112,24Zm109.66,98.34a8,8,0,0,0-8.32,1.66A88,88,0,1,1,68.29,68.29a8,8,0,0,0,11.31-11.31A104,104,0,1,0,224,128a8,8,0,0,0-2.34-5.66Z"></path></svg>
              Logout
            </button>
          </div>
        </div>

        <!-- Profil/Logout Mobile (Pindah ke sini) -->
        <div class="md:hidden">
          <button id="logout-button-mobile" class="text-sm bg-red-500 text-white px-3 py-1.5 rounded-lg hover:bg-red-600 transition duration-200">
            Logout
          </button>
        </div>
      </header>

      <!-- Tampilan Utama (Kanan) -->
      <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-gray-50">
        
        <!-- Notifikasi Global -->
        <div id="app-notification" class="hidden opacity-0 fixed top-20 right-8 z-[100] px-6 py-4 rounded-lg shadow-xl transition-all duration-300 max-w-sm">
          <span id="app-notification-message">Pesan notifikasi.</span>
          <button id="app-notification-close" class="absolute top-2 right-2 p-1 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111,163.51-63.52a12,12,0,0,1,17,17L145,128Z"></path></svg>
          </button>
        </div>
        
        <!-- Container untuk setiap view -->
        <div id="view-container">
          <!-- Konten akan di-render oleh JavaScript -->
        </div>

      </main>
    </div>

    <!-- Sidebar Mobile (Overlay) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <aside id="mobile-sidebar" class="fixed top-0 left-0 w-64 bg-slate-900 text-white h-full p-6 flex flex-col shadow-lg z-40 transform -translate-x-full transition-transform duration-300 md:hidden">
      <!-- Header Sidebar Mobile -->
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 text-transparent bg-clip-text">
          Joblist Harian
        </h2>
        <button id="mobile-sidebar-close" class="p-1">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l46.49-46.49a12,12,0,0,1,17,17L145,128Z"></path></svg>
        </button>
      </div>
      <!-- Konten Navigasi (akan disalin oleh JS) -->
      <nav id="sidebar-nav-mobile" class="flex-1 space-y-2 overflow-y-auto"></nav>
      <!-- Info User Mobile (akan disalin oleh JS) -->
      <div id="mobile-user-info" class="mt-auto"></div>
    </aside>

  </div>

  <!-- === MODAL DETAIL TUGAS USER (BARU) === -->
  <div id="user-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 transition-all">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
      <!-- Header Modal -->
      <div class="flex justify-between items-center p-4 border-b">
        <h3 id="user-task-modal-title" class="text-xl font-bold text-gray-800">Detail Tugas</h3>
        <button id="user-task-modal-close" class="p-1 rounded-full text-gray-400 hover:text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l46.49-46.49a12,12,0,0,1,17,17L145,128Z"></path></svg>
        </button>
      </div>
      <!-- Body Modal (Scrollable) -->
      <div id="user-task-modal-body" class="p-6 overflow-y-auto">
        <!-- Konten detail akan di-render oleh JS -->
      </div>
    </div>
  </div>
  <!-- ======================== -->


  <!-- ======================== -->
  <!-- SCRIPT UTAMA APLIKASI    -->
  <!-- ======================== -->
  <script>
    // --- PENTING! PASTE URL ANDA DI SINI ---
    // GANTI URL INI DENGAN URL DEPLOYMENT ANDA
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzd_xK7lzSSvUCdimLMDbGA_xaObhhAJP4LVXy0AN94vdJUNuKXm5KIAKHZecqck9q3Pw/exec'; 
    // ----------------------------------------

    // --- State Aplikasi ---
    let state = {
      isLoading: true,
      loadingMessage: 'Memuat Aplikasi...',
      currentView: 'login', // 'login' or 'app'
      currentTaskView: 'userDashboard', // Default view untuk user
      userUsername: null,
      userRole: 'user', 
      errorMessage: null,
      tasks: { 
        packing: [],
        retur: [],
        inbound: [],
        perapian: [],
        urgent: [],
      },
      completedTasks: [], 
      assignedTasks: [],  
      adminDashboardData: [], 
      userList: [], 
      assignTaskState: {
        selectedUsers: [], 
        taskBlocks: []     
      },
      tasksForApproval: [], 
      userTaskResults: {},
      adminUserStats: {}
    };
    
    let notificationTimer = null;

    // --- Helper untuk Seleksi Elemen ---
    const getEl = (id) => document.getElementById(id);

    // --- Fungsi Render Utama ---
    function render() {
      // 1. Loading
      const loadingOverlay = getEl('loading-overlay');
      const loadingMessageEl = getEl('loading-message'); 
      if (state.isLoading) {
        loadingMessageEl.textContent = state.loadingMessage;
        loadingOverlay.classList.remove('hidden');
      } else {
        loadingOverlay.classList.add('hidden');
      }

      // 2. Peringatan Konfigurasi
      getEl('config-warning').classList.toggle('hidden', GAS_WEB_APP_URL !== 'PASTE_URL_APLIKASI_WEB_ANDA_DI_SINI');
      if (GAS_WEB_APP_URL === 'PASTE_URL_APLIKASI_WEB_ANDA_DI_SINI') {
        getEl('loading-overlay').classList.add('hidden');
        return; 
      }

      // 3. View Utama (Login vs App)
      getEl('login-view').classList.toggle('hidden', state.currentView !== 'login');
      getEl('app-view').classList.toggle('hidden', state.currentView !== 'app');

      // 4. Render Bagian Login
      if (state.currentView === 'login') {
        const errorMsgEl = getEl('error-message');
        if (state.errorMessage) {
          errorMsgEl.textContent = state.errorMessage;
          errorMsgEl.classList.remove('hidden');
        } else {
          errorMsgEl.classList.add('hidden');
        }
      }

      // 5. Render Bagian Aplikasi (BERDASARKAN ROLE)
      if (state.currentView === 'app') {
        // --- PERUBAHAN: Update Info User di Header Atas ---
        getEl('user-username-display').textContent = state.userUsername;
        getEl('user-username-dropdown').textContent = state.userUsername;
        getEl('user-role-dropdown').textContent = state.userRole;
        // Salin info ke sidebar mobile
        getEl('mobile-user-info').innerHTML = `
          <p class="text-xs text-slate-400 mb-1 truncate" title="Username">${state.userUsername}</p>
          <p class="text-sm font-semibold text-indigo-300 mb-2 capitalize" title="Role">${state.userRole}</p>
        `;
        // ------------------------------------------------

        // Tampilkan/Sembunyikan Menu Sidebar
        getEl('user-menu').classList.toggle('hidden', state.userRole !== 'user');
        getEl('admin-menu').classList.toggle('hidden', state.userRole !== 'admin');
        
        // --- PERUBAHAN: Salin menu ke sidebar mobile ---
        const userMenuHtml = getEl('user-menu').innerHTML;
        const adminMenuHtml = getEl('admin-menu').innerHTML;
        getEl('sidebar-nav-mobile').innerHTML = state.userRole === 'admin' ? adminMenuHtml : userMenuHtml;
        // --------------------------------------------

        // Update Tombol Sidebar Aktif (Desktop & Mobile)
        document.querySelectorAll('.sidebar-button').forEach(btn => {
          btn.classList.toggle('bg-indigo-600', btn.dataset.view === state.currentTaskView);
          // Hapus style aktif dari tombol sub-menu jika parentnya tidak aktif
          if (btn.closest('#submenu-tugas-mandiri') && !state.currentTaskView.match(/packing|retur|inbound|perapian|urgent/)) {
            btn.classList.remove('bg-indigo-600');
          }
        });
        
        // Juga update style tombol dropdown jika anaknya aktif
        document.querySelectorAll('#toggle-tugas-mandiri').forEach(btn => {
            const isActive = state.currentTaskView.match(/packing|retur|inbound|perapian|urgent/);
            btn.classList.toggle('bg-slate-700', isActive); // Style beda untuk parent
        });


        // Render Konten Utama
        renderMainView(state.currentTaskView);
      }
    }

    // --- Fungsi Render Konten (Tabel, Laporan) ---
    function renderMainView(view) {
      const container = getEl('view-container');
      
      if (container.firstChild) {
        Array.from(container.children).forEach(child => child.classList.add('hidden'));
      }

      let viewEl = getEl(`view-${view}`);
      
      if (viewEl) {
        viewEl.classList.remove('hidden');
      } else {
        let content = '';
        switch (view) {
          case 'userDashboard':
            content = renderUserDashboardView(state.assignedTasks);
            break;
          case 'packing':
            content = renderPackingView(state.tasks.packing);
            break;
          case 'retur':
            content = renderReturView(state.tasks.retur);
            break;
          case 'inbound':
            content = renderGenericView('inbound', 'Tugas Inbound', state.tasks.inbound);
            break;
          case 'perapian':
            content = renderGenericView('perapian', 'Tugas Perapian', state.tasks.perapian);
            break;
          case 'urgent':
            content = renderGenericView('urgent', 'Tugas Urgent', state.tasks.urgent);
            break;
          case 'laporan':
            content = renderLaporanView(state.completedTasks);
            break;
          case 'adminDashboard':
            content = renderAdminDashboardView(state.adminDashboardData);
            break;
          case 'assignTask':
            content = renderAssignTaskView(state.userList, state.assignTaskState);
            break;
          case 'taskApproval':
            content = renderTaskApprovalView(state.tasksForApproval);
            break;
          default:
            content = `<p>View "${view}" tidak ditemukan.</p>`;
        }
        // Buat elemen baru, set ID, dan tambahkan
        // Ini mencegah render ulang view yang sudah ada
        const newViewEl = document.createElement('div');
        newViewEl.id = `view-${view}`; // ID untuk caching
        newViewEl.innerHTML = content;
        container.appendChild(newViewEl);
      }
    }

    // --- Render User Dashboard (Tabel) ---
    function renderUserDashboardView(tasks) {
      const tasksByType = tasks.reduce((acc, task) => {
        const type = task.taskType || 'Lainnya';
        if (!acc[type]) {
          acc[type] = [];
        }
        acc[type].push(task);
        return acc;
      }, {});

      if (tasks.length === 0) {
        return `
          <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Tugas Harian</h2>
            <div class="bg-emerald-50 border-l-4 border-emerald-500 text-emerald-800 p-6 rounded-lg shadow-md">
              <h4 class="font-bold text-lg mb-2">Pekerjaan Selesai!</h4>
              <p>Anda hebat! Semua tugas harian yang diberikan telah selesai. Tetap semangat!</p>
            </div>
          </div>
        `;
      }

      let allTables = Object.keys(tasksByType).map(taskType => {
        const tasksInGroup = tasksByType[taskType];
        
        let headerDesc = "Deskripsi";
        if (taskType === "Packing") headerDesc = "SKU";
        if (taskType === "Retur") headerDesc = "Jenis Retur";
        
        const rows = tasksInGroup.map(task => {
          const currentHasil = state.userTaskResults[task.taskId] || task.hasil || '';
          const isPendingApproval = task.status === 'Pending Approval';
          const isRejected = task.status === 'Rejected'; // <-- CEK BARU

          let deskripsiTugas = task.description;
          if (taskType === "Packing" && task.description.startsWith("Packing SKU: ")) {
            deskripsiTugas = task.description.replace("Packing SKU: ", "");
          }
          if (taskType === "Retur" && task.description.startsWith("Retur Jenis: ")) {
            deskripsiTugas = task.description.replace("Retur Jenis: ", "");
          }

          // --- TAMPILKAN STATUS DITOLAK ---
          let statusHtml;
          if (isPendingApproval) {
            statusHtml = `<span class="text-sm font-medium text-yellow-600 bg-yellow-100 px-3 py-1.5 rounded-full">Menunggu ACC</span>`;
          } else if (isRejected) {
             statusHtml = `
                <button 
                  data-task-id="${task.taskId}"
                  data-target-qty="${task.quantity}"
                  class="konfirmasi-tugas-btn bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow hover:bg-blue-700 transition duration-200 text-sm">
                  Kirim Ulang
                </button>
                <span class="text-xs text-red-600 block mt-1 font-medium">Ditolak</span>
              `;
          } else {
             statusHtml = `
                <button 
                  data-task-id="${task.taskId}"
                  data-target-qty="${task.quantity}"
                  class="konfirmasi-tugas-btn bg-emerald-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow hover:bg-emerald-700 transition duration-200 text-sm">
                  Konfirmasi
                </button>
             `;
          }
          // --- AKHIR PERUBAHAN STATUS ---

          return `
            <tr class="hover:bg-gray-50 ${isRejected ? 'bg-red-50' : ''}"> <!-- Sorot baris ditolak -->
              <td class="px-4 py-3 text-sm text-gray-700 font-medium">${deskripsiTugas}</td>
              <td class="px-4 py-3 text-sm text-gray-700 text-center">${task.quantity}</td>
              <td class="px-4 py-3">
                <input 
                  type="number" 
                  value="${currentHasil}"
                  data-task-id="${task.taskId}"
                  class="task-hasil-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500" 
                  placeholder="0"
                  min="0"
                  ${isPendingApproval ? 'disabled' : ''} 
                >
              </td>
              <td class="px-4 py-3 text-center">
                ${statusHtml} <!-- Gunakan HTML status baru -->
              </td>
            </tr>
          `;
        }).join('');

        return `
          <div class="mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">${taskType}</h3>
            <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">${headerDesc}</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Target</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Hasil</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Status</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');


      return `
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-900">Dashboard Tugas Harian</h2>
            <!-- Refresh dipindah ke header atas -->
          </div>
          <div>
            ${allTables}
          </div>
        </div>
      `;
    }

    // --- Render Admin Dashboard ---
    function renderAdminDashboardView(data) {
      let stats = {
        pending: 0,
        pendingApproval: 0, 
        completed: 0,
        rejected: 0, // <-- STATS BARU
        total: data.length,
        totalCompletedQuantity: 0, 
        byType: {}
      };
      
      let userStatsData = {}; 

      data.forEach(row => {
        const status = row[6];
        const user = row[1];
        const type = row[3];
        const description = row[4]; 
        const targetQty = parseInt(row[5] || 0, 10); 
        const hasilQty = parseInt(row[8] || 0, 10); 

        if (status === 'Pending') stats.pending++;
        if (status === 'Pending Approval') stats.pendingApproval++;
        if (status === 'Rejected') stats.rejected++; // <-- HITUNG STATS BARU
        if (status === 'Completed') {
          stats.completed++;
          stats.totalCompletedQuantity += hasilQty;
        }
        
        if (!userStatsData[user]) {
          userStatsData[user] = { taskCount: 0, totalQuantity: 0, tasks: [] };
        }
        userStatsData[user].taskCount++;
        
        if (status === 'Completed' || status === 'Pending Approval') {
          userStatsData[user].totalQuantity += hasilQty;
        }
        
        userStatsData[user].tasks.push({
          description: description,
          type: type,
          target: targetQty,
          hasil: hasilQty,
          status: status
        });
        
        stats.byType[type] = (stats.byType[type] || 0) + 1;
      });
      
      state.adminUserStats = userStatsData;

      const userStatsHtml = Object.keys(userStatsData).sort().map(user => {
        const userData = userStatsData[user];
        return `
            <li class="flex justify-between items-center p-3 hover:bg-gray-50 rounded">
              <div>
                <span class="font-medium text-gray-700">${user}</span>
                <span class="text-sm text-gray-500 block">${userData.taskCount} tugas</span>
              </div>
              <div class="text-right">
                 <span class="text-gray-600 font-medium">Total: ${userData.totalQuantity} items</span>
                 <button 
                   data-username="${user}"
                   class="user-details-btn text-sm text-blue-600 hover:text-blue-800 block font-medium">
                   Lihat Detail
                 </button>
              </div>
            </li>
          `;
      }).join('') || '<p class="text-gray-500 p-3">Belum ada data.</p>';
      
      const typeStats = Object.keys(stats.byType).map(type => `
        <li class="flex justify-between items-center p-3 hover:bg-gray-50 rounded">
          <span class="font-medium text-gray-700">${type}</span>
          <span class="text-gray-500">${stats.byType[type]} tugas</span>
        </li>
      `).join('') || '<p class="text-gray-500 p-3">Belum ada data.</p>';

      return `
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-6">Admin Dashboard</h2>
          
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"> <!-- DIUBAH JADI 5 KOLOM -->
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h4 class="text-sm font-medium text-blue-700">Total Tugas</h4>
              <p class="text-3xl font-bold text-blue-900">${stats.total}</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h4 class="text-sm font-medium text-yellow-700">Pending</h4>
              <p class="text-3xl font-bold text-yellow-900">${stats.pending}</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h4 class="text-sm font-medium text-orange-700">Menunggu ACC</h4>
              <p class="text-3xl font-bold text-orange-900">${stats.pendingApproval}</p>
            </div>
             <!-- KARTU BARU -->
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h4 class="text-sm font-medium text-red-700">Ditolak</h4>
              <p class="text-3xl font-bold text-red-900">${stats.rejected}</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h4 class="text-sm font-medium text-emerald-700">Tugas Selesai</h4>
              <p class="text-3xl font-bold text-emerald-900">${stats.completed}</p>
              <p class="text-sm font-medium text-gray-500 mt-1">Total Items: ${stats.totalCompletedQuantity}</p>
            </div>
          </div>
          
          <!-- Stats Lists -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h3 class="font-semibold text-gray-800 mb-3">Tugas per User</h3>
              <ul class="divide-y divide-gray-200">${userStatsHtml}</ul>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-lg border">
              <h3 class="font-semibold text-gray-800 mb-3">Tugas per Tipe</h3>
              <ul class="divide-y divide-gray-200">${typeStats}</ul>
            </div>
          </div>
        </div>
      `;
    }

    // --- (REWRITE BESAR) Render Admin Beri Tugas ---
    
    // Helper 1: Render Pilihan Karyawan (Checkboxes)
    function renderUserSelection(users, selectedUsers) {
      if (users.length === 0) {
        return '<p class="text-sm text-gray-500">Memuat daftar karyawan...</p>';
      }
      
      return users.map(user => `
        <label class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input 
            type="checkbox"
            value="${user}"
            class="assign-user-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            ${selectedUsers.includes(user) ? 'checked' : ''}
          >
          <span class="text-gray-700 font-medium">${user}</span>
        </label>
      `).join('');
    }

    // Helper 2: Render 1 Baris Tugas (di dalam blok)
    function renderAssignTaskRow(row, type, blockId) {
      const rowId = row.id;
      let fields = '';

      if (type === 'Packing') {
        fields = `
          <td class="px-1 py-2 w-3/5">
            <input type="text" data-block-id="${blockId}" data-row-id="${rowId}" data-field="sku" value="${row.sku || ''}" class="assign-task-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="SKU...">
          </td>
          <td class="px-1 py-2 w-1/5">
            <input type="number" data-block-id="${blockId}" data-row-id="${rowId}" data-field="quantity" value="${row.quantity || 1}" min="1" class="assign-task-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
          </td>
        `;
      } else if (type === 'Retur') {
        fields = `
          <td class="px-1 py-2 w-3/5">
            <select data-block-id="${blockId}" data-row-id="${rowId}" data-field="jenis" class="assign-task-select w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white">
              <option value="Input" ${row.jenis === 'Input' ? 'selected' : ''}>Input</option>
              <option value="Bongkar" ${row.jenis === 'Bongkar' ? 'selected' : ''}>Bongkar</option>
              <option value="Repack" ${row.jenis === 'Repack' ? 'selected' : ''}>Repack</option>
            </select>
          </td>
          <td class="px-1 py-2 w-1/5">
            <input type="number" data-block-id="${blockId}" data-row-id="${rowId}" data-field="quantity" value="${row.quantity || 1}" min="1" class="assign-task-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
          </td>
        `;
      } else { // Inbound, Perapian, Urgent, Lainnya
        fields = `
          <td class="px-1 py-2 w-3/5">
            <input type="text" data-block-id="${blockId}" data-row-id="${rowId}" data-field="description" value="${row.description || ''}" class="assign-task-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Deskripsi tugas...">
          </td>
          <td class="px-1 py-2 w-1/5">
            <input type="number" data-block-id="${blockId}" data-row-id="${rowId}" data-field="quantity" value="${row.quantity || 1}" min="1" class="assign-task-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
          </td>
        `;
      }

      return `
        <tr id="row-${rowId}">
          ${fields}
          <td class="px-1 py-2 text-center w-1/5">
            <button type="button" data-block-id="${blockId}" data-row-id="${rowId}" class="remove-assign-task-row p-1 text-red-500 hover:text-red-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192Zm-80-104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
            </button>
          </td>
        </tr>
      `;
    }

    // Helper 3: Render 1 Blok Tipe Tugas
    function renderAssignTaskBlock(block) {
      let headers = '';
      if (block.type === 'Packing') {
        headers = `
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">SKU</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Jumlah</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Hapus</th>
        `;
      } else if (block.type === 'Retur') {
        headers = `
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Jenis</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Jumlah</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Hapus</th>
        `;
      } else {
        headers = `
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Deskripsi</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Jumlah</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Hapus</th>
        `;
      }
      
      const tableRows = block.rows.map(row => renderAssignTaskRow(row, block.type, block.id)).join('');

      return `
        <div class="mt-6 border border-gray-300 rounded-lg p-4 bg-white shadow-sm">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-bold text-gray-900">${block.type}</h3>
            <button type="button" data-block-id="${block.id}" class="remove-task-block p-1 text-gray-400 hover:text-red-600">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l46.49-46.49a12,12,0,0,1,17,17L145,128Z"></path></svg>
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-gray-50">
                <tr>${headers}</tr>
              </thead>
              <tbody class="divide-y divide-gray-200">${tableRows}</tbody>
            </table>
          </div>
          <button type="button" data-block-id="${block.id}" class="add-assign-task-row mt-4 bg-blue-500 text-white font-medium py-1.5 px-3 rounded-lg shadow hover:bg-blue-600 transition duration-200 text-sm">
            + Tambah Baris
          </button>
        </div>
      `;
    }

    // Helper 4: Render View Utama "Beri Tugas"
    function renderAssignTaskView(users, assignState) {
      
      const userSelectionHtml = renderUserSelection(users, assignState.selectedUsers);
      const taskBlocksHtml = assignState.taskBlocks.map(block => renderAssignTaskBlock(block)).join('');

      return `
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl max-w-3xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">Beri Tugas Baru</h2>
          <form id="assign-task-form">
            
            <!-- 1. Pemilihan Karyawan -->
            <div class="mb-6">
              <label class="block text-lg font-medium text-gray-800 mb-2">1. Pilih Karyawan</label>
              <div id="assign-user-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 border border-gray-300 rounded-lg p-4 max-h-48 overflow-y-auto bg-gray-50">
                ${userSelectionHtml}
              </div>
            </div>

            <!-- 2. Pemilihan Tipe Tugas -->
            <div class="mb-4">
              <label class="block text-lg font-medium text-gray-800 mb-2">2. Tambah Blok Tugas</label>
              <div class="flex gap-4">
                <select id="add-task-type-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="Packing">Packing</option>
                  <option value="Retur">Retur</option>
                  <option value="Inbound">Inbound</option>
                  <option value="Perapian">Perapian</option>
                  <option value="Urgent">Urgent</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
                <button type="button" id="add-task-block-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition whitespace-nowrap">
                  + Tambah Blok
                </button>
              </div>
            </div>

            <!-- 3. Daftar Blok Tugas -->
            <div id="task-blocks-container">
              ${taskBlocksHtml.length > 0 ? taskBlocksHtml : '<p id="no-task-block-msg" class="text-center text-gray-500 mt-8 py-4">Silakan tambah blok tugas.</p>'}
            </div>
            
            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition duration-300 mt-8">
              Kirim Semua Tugas ke Karyawan Terpilih
            </button>
          </form>
        </div>
      `;
    }

    // --- Render View Admin (PERSETUJUAN) ---
    // *** PERUBAHAN BESAR DI SINI ***
    function renderTaskApprovalView(tasks) {
      let rows = '';
      if (tasks.length === 0) {
        rows = `
          <tr>
            <td colspan="6" class="text-center text-gray-500 py-10">
              Tidak ada tugas yang menunggu persetujuan.
            </td>
          </tr>
        `;
      } else {
        rows = tasks.map(row => {
          const taskId = row[0];
          const user = row[1];
          const taskType = row[3]
          const taskDesc = row[4];
          const target = row[5];
          const hasil = row[8]; 
          
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-800 font-medium">${user}</td>
              <td class="px-4 py-3 text-sm text-gray-700">
                <span class="font-bold">${taskType}</span>: ${taskDesc}
              </td>
              <td class="px-4 py-3 text-sm text-gray-700 text-center">${target}</td>
              <td class="px-4 py-3"> <!-- Kolom Hasil Diubah -->
                <input 
                  type="number" 
                  value="${hasil}"
                  data-task-id="${taskId}"
                  class="approval-hasil-input w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500" 
                  placeholder="0"
                  min="0"
                >
              </td>
              <td class="px-4 py-3 text-center space-x-2 whitespace-nowrap"> <!-- Kolom Aksi Diubah -->
                <button 
                  data-task-id="${taskId}"
                  class="approve-task-btn bg-emerald-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow hover:bg-emerald-700 transition duration-200 text-sm">
                  Setujui
                </button>
                <button 
                  data-task-id="${taskId}"
                  class="reject-task-btn bg-red-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow hover:bg-red-700 transition duration-200 text-sm">
                  Tolak
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      return `
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">Persetujuan Tugas</h2>
          <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Karyawan</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Tugas</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Target</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Hasil</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Aksi</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }


    // --- Render Tugas Mandiri ---
    function renderPackingView(items) {
      const rows = items.map((item, index) => `
        <tr>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <input 
              type="text" 
              value="${item.sku || ''}"
              data-task-type="packing" data-index="${index}" data-field="sku"
              class="task-input w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Masukkan SKU..."
            />
          </td>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <input 
              type="number" 
              value="${item.jumlah || ''}"
              data-task-type="packing" data-index="${index}" data-field="jumlah"
              class="task-input w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
              min="0"
              placeholder="0"
            />
          </td>
        </tr>
      `).join('');

      return `
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Tugas Mandiri: Packing</h2>
          <p class="text-gray-600 mb-6">Input pekerjaan mandiri (packing) yang sudah Anda kerjakan di sini untuk dikirim ke Admin.</p>
          <div class="overflow-x-auto rounded-lg border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">SKU</th>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Jumlah (Hasil)</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
            </table>
          </div>
          <button data-task-type="packing" class="add-row-button mt-6 bg-blue-500 text-white font-medium py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-200">
            + Tambah Baris
          </button>
          <button data-task-type="packing" class="submit-mandiri-button mt-6 ml-4 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition duration-200">
            Kirim untuk Persetujuan
          </button>
        </div>
      `;
    }
    function renderReturView(items) {
      const rows = items.map((item, index) => `
        <tr>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <select 
              data-task-type="retur" data-index="${index}" data-field="jenis"
              class="task-input task-select w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white"
            >
              <option value="Input" ${item.jenis === 'Input' ? 'selected' : ''}>Input</option>
              <option value="Bongkar" ${item.jenis === 'Bongkar' ? 'selected' : ''}>Bongkar</option>
              <option value="Repack" ${item.jenis === 'Repack' ? 'selected' : ''}>Repack</option>
            </select>
          </td>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <input 
              type="number" 
              value="${item.jumlah || ''}"
              data-task-type="retur" data-index="${index}" data-field="jumlah"
              class="task-input w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
              min="0"
              placeholder="0"
            />
          </td>
        </tr>
      `).join('');

      return `
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Tugas Mandiri: Retur</h2>
           <p class="text-gray-600 mb-6">Input pekerjaan mandiri (retur) yang sudah Anda kerjakan di sini.</p>
          <div class="overflow-x-auto rounded-lg border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Jenis Pekerjaan</th>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Jumlah (Hasil)</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
            </table>
          </div>
          <button data-task-type="retur" class="add-row-button mt-6 bg-blue-500 text-white font-medium py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-200">
            + Tambah Baris
          </button>
          <button data-task-type="retur" class="submit-mandiri-button mt-6 ml-4 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition duration-200">
            Kirim untuk Persetujuan
          </button>
        </div>
      `;
    }
    function renderGenericView(taskType, title, items) {
      const rows = items.map((item, index) => `
        <tr>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <input 
              type="text" 
              value="${item.tugas || ''}"
              data-task-type="${taskType}" data-index="${index}" data-field="tugas"
              class="task-input w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Nama tugas..."
            />
          </td>
          <td class="px-3 md:px-6 py-4 whitespace-nowrap">
            <input 
              type="number" 
              value="${item.keterangan || ''}"
              data-task-type="${taskType}" data-index="${index}" data-field="keterangan"
              class="task-input w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="0"
              min="0"
            />
          </td>
        </tr>
      `).join('');

      return `
        <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Tugas Mandiri: ${title}</h2>
           <p class="text-gray-600 mb-6">Input pekerjaan mandiri (${taskType}) yang sudah Anda kerjakan di sini.</p>
          <div class="overflow-x-auto rounded-lg border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Tugas</th>
                  <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Jumlah (Hasil)</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
            </table>
          </div>
          <button data-task-type="${taskType}" class="add-row-button mt-6 bg-blue-500 text-white font-medium py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-200">
            + Tambah Baris
          </button>
          <button data-task-type="${taskType}" class="submit-mandiri-button mt-6 ml-4 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition duration-200">
            Kirim untuk Persetujuan
          </button>
        </div>
      `;
    }
    
    // --- Render Laporan (Hasil Pekerjaan) ---
    function renderLaporanView(items) {
      const tasksByType = items.reduce((acc, task) => {
        const type = task.type || 'Lainnya'; 
        if (!acc[type]) {
          acc[type] = [];
        }
        acc[type].push(task);
        return acc;
      }, {});

      let content = '';
      if (items.length === 0) {
        content = `
          <div class="bg-white p-6 rounded-xl shadow-lg border text-center">
            <p class="text-gray-500">Belum ada pekerjaan yang diselesaikan.</p>
          </div>
        `;
      } else {
        content = Object.keys(tasksByType).sort().map(taskType => {
          const tasksInGroup = tasksByType[taskType];
          const totalJumlah = tasksInGroup.reduce((sum, task) => sum + (parseInt(task.hasil, 10) || 0), 0); 
          
          const taskRows = tasksInGroup.map(item => {
             let deskripsi = item.taskName || 'Tidak ada deskripsi';
             if (item.type === 'Packing' && deskripsi.startsWith('Packing SKU: ')) {
               deskripsi = deskripsi.replace('Packing SKU: ', '');
             } else if (item.type === 'Retur' && deskripsi.startsWith('Retur Jenis: ')) {
               deskripsi = deskripsi.replace('Retur Jenis: ', '');
             }
             const jumlah = item.hasil || 0; 
             
             return `
              <tr class="hover:bg-gray-50 border-b last:border-b-0">
                <td class="px-4 py-3 text-sm text-gray-800">${deskripsi}</td>
                <td class="px-4 py-3 text-sm text-blue-700 font-bold text-center">${jumlah}</td>
              </tr>
             `;
          }).join('');

          return `
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
              <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">${taskType}</h3>
                <span class="text-sm font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full">Total: ${totalJumlah}</span>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full">
                  <thead class="bg-white">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/4">Tugas / Deskripsi</th>
                      <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    ${taskRows}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }).join('');
      }

      return `
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Laporan Pekerjaan Selesai</h2>
          <p class="text-gray-600 mb-6">Laporan ini mencatat semua tugas (Harian & Mandiri) yang telah disetujui oleh Admin.</p>
          <div class="space-y-6">
            ${content}
          </div>
        </div>
      `;
    }


    // --- Fungsi Aksi & Jaringan (Networking) ---
    
    function setState(newState) {
      if (newState.currentTaskView && newState.currentTaskView === state.currentTaskView) {
         const oldView = getEl(`view-${state.currentTaskView}`);
         if (oldView) oldView.remove();
      }
      
      if (newState.tasks) {
         Object.keys(newState.tasks).forEach(taskType => {
           const oldView = getEl(`view-${taskType}`);
           if (oldView) oldView.remove();
         });
      }
      if (newState.assignTaskState) {
         const oldView = getEl('view-assignTask');
         if (oldView) oldView.remove();
         state.assignTaskState = { ...state.assignTaskState, ...newState.assignTaskState };
         delete newState.assignTaskState;
      }
      
      state = { ...state, ...newState };
      render();
    }
    
    // --- Fungsi Notifikasi ---
    function showNotification(message, isError = true) {
      const notif = getEl('app-notification');
      const notifMsg = getEl('app-notification-message');
      
      notifMsg.textContent = message;
      notif.className = 'fixed top-24 right-8 z-[100] px-6 py-4 rounded-lg shadow-xl transition-all duration-300 max-w-sm'; 
      
      if (isError) {
        notif.classList.add('bg-red-500', 'text-white');
      } else {
        notif.classList.add('bg-emerald-500', 'text-white');
      }
      
      notif.classList.remove('hidden');
      setTimeout(() => notif.classList.remove('opacity-0'), 10);

      if (notificationTimer) clearTimeout(notificationTimer);
      notificationTimer = setTimeout(hideNotification, 3000);
    }

    function hideNotification() {
      const notif = getEl('app-notification');
      notif.classList.add('opacity-0');
      if (notificationTimer) clearTimeout(notificationTimer);
      setTimeout(() => notif.classList.add('hidden'), 300);
    }
    
    // --- Fungsi Toggle Password ---
    function setupPasswordToggle(buttonId, inputId) {
      const button = getEl(buttonId);
      const input = getEl(inputId);
      if (!button || !input) return; 
      const eyeOpen = button.querySelector('.eye-icon-open');
      const eyeClosed = button.querySelector('.eye-icon-closed');

      button.addEventListener('click', () => {
        if (input.type === 'password') {
          input.type = 'text';
          eyeOpen.classList.add('hidden');
          eyeClosed.classList.remove('hidden');
        } else {
          input.type = 'password';
          eyeOpen.classList.remove('hidden');
          eyeClosed.classList.add('hidden');
        }
      });
    }

    // --- Handler Login ---
    async function handleLogin(event) {
      event.preventDefault();
      setState({ isLoading: true, loadingMessage: 'Logging in...', errorMessage: null });
      hideNotification(); 

      const username = getEl('login-username').value;
      const password = getEl('login-password').value;
      
      const url = GAS_WEB_APP_URL;
      const payload = {
        action: 'login',
        username: username,
        password: password
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' } 
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (result.status === 'success') {
          const { username, role } = result.data;
          
          localStorage.setItem('dailyTaskUser', JSON.stringify({ username, password }));

          let defaultView = role === 'admin' ? 'adminDashboard' : 'userDashboard';
          const hashView = window.location.hash.substring(1);
          
          if (hashView) {
             const validUserViews = ['userDashboard', 'packing', 'retur', 'inbound', 'perapian', 'urgent', 'laporan'];
             const validAdminViews = ['adminDashboard', 'assignTask', 'taskApproval'];
             
             if ((role === 'user' && validUserViews.includes(hashView)) || 
                 (role === 'admin' && validAdminViews.includes(hashView))) 
             {
               defaultView = hashView;
               
               if (validUserViews.includes(hashView) && hashView !== 'userDashboard' && hashView !== 'laporan') {
                   setTimeout(() => { 
                     document.querySelectorAll('#submenu-tugas-mandiri').forEach(submenu => submenu.classList.remove('hidden'));
                     document.querySelectorAll('#arrow-tugas-mandiri').forEach(arrow => arrow.classList.add('rotate-180'));
                   }, 100);
               }
             }
          }

          if (role === 'admin') {
            setState({
              userUsername: username,
              userRole: 'admin',
              currentView: 'app',
              currentTaskView: defaultView,
              isLoading: false,
            });
            fetchAdminData();
          } else {
            setState({
              userUsername: username,
              userRole: 'user',
              completedTasks: result.data.completedTasks.map(t => ({...t, completedAt: new Date(t.completedAt)})),
              currentView: 'app',
              currentTaskView: defaultView,
              isLoading: false,
            });
            fetchUserTasks();
          }
        } else {
          setState({ errorMessage: result.message, isLoading: false });
          localStorage.removeItem('dailyTaskUser');
        }
      } catch (error) {
        console.error("Login fetch error:", error);
        setState({ errorMessage: "Tidak dapat terhubung ke server.", isLoading: false });
      }
    }

    // --- Handler Logout ---
    function handleLogout() {
      localStorage.removeItem('dailyTaskUser');
      
      try {
        history.pushState(null, '', window.location.pathname);
      } catch (e) {
        console.warn("Gagal membersihkan URL (pushState error):", e.message);
        window.location.hash = '';
      }
      
      getEl('login-username').value = '';
      getEl('login-password').value = '';
      setState({
        userUsername: null,
        userRole: 'user',
        currentView: 'login',
        currentTaskView: 'userDashboard',
        tasks: { packing: [], retur: [], inbound: [], perapian: [], urgent: [] },
        completedTasks: [],
        assignedTasks: [],
        adminDashboardData: [],
        userList: [],
        assignTaskState: { selectedUsers: [], taskBlocks: [] },
        tasksForApproval: [],
      }); 
      hideNotification();
    }

    // --- Sync Data ---
    async function syncData() {
      setState({ isLoading: true, loadingMessage: 'Sinkronisasi data...' });
      hideNotification();
      
      if (state.userRole === 'admin') {
        await fetchAdminData();
        await fetchTasksForApproval(); 
      } else {
        await fetchUserTasks(); 
      }
      
      setState({ isLoading: false });
      showNotification("Data berhasil disinkronkan.", false);
    }

    // --- Fetch Data (Admin) ---
    async function fetchAdminData() {
      setState({ isLoading: true, loadingMessage: 'Memuat data admin...' });
      try {
        const [dashResponse, usersResponse] = await Promise.all([
          fetch(`${GAS_WEB_APP_URL}?action=getAdminDashboard&username=${state.userUsername}`),
          fetch(`${GAS_WEB_APP_URL}?action=getUsers&username=${state.userUsername}`)
        ]);
        
        const dashResult = await dashResponse.json();
        const usersResult = await usersResponse.json();
        
        let partialState = {};
        if (dashResult.status === 'success') {
          partialState.adminDashboardData = dashResult.data;
        }
        if (usersResult.status === 'success') {
          partialState.userList = usersResult.users;
        }
        
        const oldDashView = getEl('view-adminDashboard');
        if(oldDashView) oldDashView.remove();
        const oldAssignView = getEl('view-assignTask');
        if(oldAssignView) oldAssignView.remove();
        
        setState(partialState);

      } catch (err) {
        showNotification("Gagal memuat data admin: " + err.message, true);
      }
      setState({ isLoading: false });
    }

    // --- Fetch Data (User) ---
    async function fetchUserTasks() {
      setState({ isLoading: true, loadingMessage: 'Memuat tugas harian...' });
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getMyTasks&username=${state.userUsername}`);
        const result = await response.json();
        
        if (result.status === 'success') {
          const oldView = getEl('view-userDashboard');
          if(oldView) oldView.remove();
          setState({ assignedTasks: result.tasks, isLoading: false });
        } else {
          throw new Error(result.message);
        }
      } catch (err) {
        showNotification("Gagal memuat tugas harian: " + err.message, true);
        setState({ isLoading: false });
      }
    }

    // --- Fetch data untuk persetujuan Admin ---
    async function fetchTasksForApproval() {
      setState({ isLoading: true, loadingMessage: 'Memuat data persetujuan...' });
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getTasksForApproval&username=${state.userUsername}`);
        const result = await response.json();
        
        if (result.status === 'success') {
          const oldView = getEl('view-taskApproval');
          if(oldView) oldView.remove();
          setState({ tasksForApproval: result.data, isLoading: false });
        } else {
          throw new Error(result.message);
        }
      } catch (err) {
        showNotification("Gagal memuat data persetujuan: " + err.message, true);
        setState({ isLoading: false });
      }
    }


    // --- Logika klik sidebar ---
    function handleSidebarClick(event) {
      const button = event.target.closest('.sidebar-button');
      if (button) {
        const view = button.dataset.view;
        navigateToView(view); 
      }
    }

    // --- FUNGSI NAVIGASI BARU (REFAKTOR) ---
    function navigateToView(view) {
      if (!view) return; 
      
      closeMobileSidebar();
      hideUserDetailsModal(); 

      if (view !== state.currentTaskView) {
         const newState = { view: view };
         const url = `#${view}`; 
         try {
           history.pushState(newState, '', url);
         } catch (e) {
           console.error("History pushState failed", e);
         }
      }
      
      if (view === 'assignTask') {
        if (state.userList.length === 0) {
          fetchAdminData();
        }
        const newBlockId = crypto.randomUUID();
        const newRowId = crypto.randomUUID();
        setState({ 
          currentTaskView: view,
          assignTaskState: {
            selectedUsers: [],
            taskBlocks: [
              { id: newBlockId, type: 'Packing', rows: [{id: newRowId, sku: '', quantity: 1}] }
            ]
          }
        });
      } 
      else if (view === 'adminDashboard') {
        fetchAdminData(); 
        setState({ currentTaskView: view });
      }
      else if (view === 'taskApproval') {
        fetchTasksForApproval(); 
        setState({ currentTaskView: view });
      }
      else if (view === 'userDashboard') {
        fetchUserTasks(); 
        setState({ currentTaskView: view });
      }
      else if (['packing', 'retur', 'inbound', 'perapian', 'urgent'].includes(view)) {
         setState({ 
           currentTaskView: view,
           tasks: {
             ...state.tasks,
             [view]: [] 
           }
         });
      }
      else {
        setState({ currentTaskView: view });
      }
    }


    // --- Logika klik Konten Utama ---
    function handleViewContainerClick(event) {
      const target = event.target;
      const button = target.closest('button');
      if (!button) return; 

      if (button.classList.contains('submit-mandiri-button')) {
        const taskType = button.dataset.taskType;
        handleSubmitMandiriTasks(taskType);
      }
      if (button.classList.contains('add-row-button')) {
        const taskType = button.dataset.taskType;
        handleAddRow(taskType);
      }
      if (button.classList.contains('konfirmasi-tugas-btn')) {
        const taskId = button.dataset.taskId;
        const targetQty = parseInt(button.dataset.targetQty, 10);
        const hasilQtyStr = state.userTaskResults[taskId] || '0';
        const hasilQty = parseInt(hasilQtyStr, 10);

        if (isNaN(hasilQty) || hasilQty < 0) {
          showNotification("Input 'Hasil' tidak valid. Harap isi angka.", true);
          return;
        }
        handleSubmitTaskForApproval(taskId, hasilQty, targetQty);
      }
      
      const blockId = button.dataset.blockId;
      const rowId = button.dataset.rowId;

      if (button.id === 'add-task-block-btn') {
        const newType = getEl('add-task-type-select').value;
        const newBlockId = crypto.randomUUID();
        const newRowId = crypto.randomUUID();
        let newRow;
        
        if (newType === 'Packing') {
          newRow = { id: newRowId, sku: '', quantity: 1 };
        } else if (newType === 'Retur') {
          newRow = { id: newRowId, jenis: 'Input', quantity: 1 };
        } else {
          newRow = { id: newRowId, description: '', quantity: 1 };
        }
        const newBlock = { id: newBlockId, type: newType, rows: [newRow] };
        setState({
          assignTaskState: {
            taskBlocks: [...state.assignTaskState.taskBlocks, newBlock]
          }
        });
        const noTaskMsg = getEl('no-task-block-msg');
        if (noTaskMsg) noTaskMsg.classList.add('hidden');
      }
      else if (button.classList.contains('remove-task-block') && blockId) {
        const newBlocks = state.assignTaskState.taskBlocks.filter(b => b.id !== blockId);
        setState({ assignTaskState: { taskBlocks: newBlocks } });
      }
      else if (button.classList.contains('add-assign-task-row') && blockId) {
        const newRowId = crypto.randomUUID();
        let newRow;
        const blockType = state.assignTaskState.taskBlocks.find(b => b.id === blockId).type;

        if (blockType === 'Packing') {
          newRow = { id: newRowId, sku: '', quantity: 1 };
        } else if (blockType === 'Retur') {
          newRow = { id: newRowId, jenis: 'Input', quantity: 1 };
        } else {
          newRow = { id: newRowId, description: '', quantity: 1 };
        }
        
        const newBlocks = state.assignTaskState.taskBlocks.map(block => {
          if (block.id === blockId) {
            return { ...block, rows: [...block.rows, newRow] };
          }
          return block;
        });
        setState({ assignTaskState: { taskBlocks: newBlocks } });
      }
      else if (button.classList.contains('remove-assign-task-row') && blockId && rowId) {
        const newBlocks = state.assignTaskState.taskBlocks.map(block => {
          if (block.id === blockId) {
            const newRows = block.rows.filter(r => r.id !== rowId);
            if (newRows.length === 0) {
              const newRowId = crypto.randomUUID();
              if (block.type === 'Packing') {
                newRows.push({ id: newRowId, sku: '', quantity: 1 });
              } else if (block.type === 'Retur') {
                newRows.push({ id: newRowId, jenis: 'Input', quantity: 1 });
              } else {
                newRows.push({ id: newRowId, description: '', quantity: 1 });
              }
            }
            return { ...block, rows: newRows };
          }
          return block;
        });
        setState({ assignTaskState: { taskBlocks: newBlocks } });
      }

      // *** PERUBAHAN DI SINI ***
      // Tombol Admin menyetujui tugas
      if (button.classList.contains('approve-task-btn')) {
        const taskId = button.dataset.taskId;
        // Ambil nilai 'hasil' dari input terdekat
        const inputEl = document.querySelector(`.approval-hasil-input[data-task-id="${taskId}"]`);
        let hasilQty = null;
        if (inputEl) {
          hasilQty = parseInt(inputEl.value, 10);
        }
        if (isNaN(hasilQty) || hasilQty < 0) {
          showNotification("Nilai 'Hasil' tidak valid.", true);
          return; // Hentikan jika 'hasil' tidak valid
        }
        handleApproveTask(taskId, hasilQty); // Kirim 'hasil' yang sudah diedit
      }
      // Tombol Admin menolak tugas (BARU)
      else if (button.classList.contains('reject-task-btn')) {
        const taskId = button.dataset.taskId;
        handleRejectTask(taskId);
      }
      // *** AKHIR PERUBAHAN ***
      
      // Tombol Admin melihat detail tugas user
      if (button.classList.contains('user-details-btn')) {
        const username = button.dataset.username;
        showUserDetailsModal(username);
      }
    }
    
    // --- Logika Input ---
    function handleViewContainerInput(event) {
      const target = event.target;
      
      if (target.classList.contains('task-input')) {
        const { taskType, index, field } = target.dataset;
        const value = (target.type === 'number' && target.value !== '') ? Number(target.value) : target.value;
        const newItems = [...state.tasks[taskType]];
        if (newItems[index]) {
            newItems[index][field] = value;
            state.tasks[taskType] = newItems; 
        }
      }
      if (target.classList.contains('task-select')) {
         const { taskType, index, field } = target.dataset;
         const newItems = [...state.tasks[taskType]];
         if (newItems[index]) {
            newItems[index][field] = target.value;
            state.tasks[taskType] = newItems;
         }
      }
      
      const blockId = target.dataset.blockId;
      const rowId = target.dataset.rowId;
      const field = target.dataset.field;
      if (target.classList.contains('assign-task-input') && blockId && rowId && field) {
        const newBlocks = state.assignTaskState.taskBlocks.map(block => {
          if (block.id === blockId) {
            const newRows = block.rows.map(row => {
              if (row.id === rowId) {
                return { ...row, [field]: target.value };
              }
              return row;
            });
            return { ...block, rows: newRows };
          }
          return block;
        });
        state.assignTaskState.taskBlocks = newBlocks;
      }

      if (target.classList.contains('task-hasil-input')) {
        const taskId = target.dataset.taskId;
        const value = target.value;
        state.userTaskResults[taskId] = value;
      }
    }
    
    // --- Logika Ganti Pilihan (Change) ---
    function handleViewContainerChange(event) {
      const target = event.target;
      
      if (target.classList.contains('assign-user-checkbox')) {
        const user = target.value;
        const isChecked = target.checked;
        let newSelectedUsers = [...state.assignTaskState.selectedUsers];
        if (isChecked) {
          if (!newSelectedUsers.includes(user)) {
            newSelectedUsers.push(user);
          }
        } else {
          newSelectedUsers = newSelectedUsers.filter(u => u !== user);
        }
        state.assignTaskState.selectedUsers = newSelectedUsers;
        return; 
      }
      
      const blockId = target.dataset.blockId;
      const rowId = target.dataset.rowId;
      const field = target.dataset.field;
      if (target.classList.contains('assign-task-select') && blockId && rowId && field) {
        const newBlocks = state.assignTaskState.taskBlocks.map(block => {
          if (block.id === blockId) {
            const newRows = block.rows.map(row => {
              if (row.id === rowId) {
                return { ...row, [field]: target.value };
              }
              return row;
            });
            return { ...block, rows: newRows };
          }
          return block;
        });
        state.assignTaskState.taskBlocks = newBlocks;
      }
    }
    
    // --- Logika Submit Form ---
    function handleViewContainerSubmit(event) {
      event.preventDefault();
      const target = event.target;
      
      if (target.id === 'assign-task-form') {
        const selectedUsers = state.assignTaskState.selectedUsers;
        const taskBlocks = state.assignTaskState.taskBlocks;
        
        if (selectedUsers.length === 0) {
          showNotification("Harap pilih minimal satu karyawan.", true);
          return;
        }
        if (taskBlocks.length === 0) {
          showNotification("Harap tambahkan minimal satu blok tugas.", true);
          return;
        }
        
        let isValid = true;
        let errorMsg = "";
        
        for (const block of taskBlocks) {
          for (const row of block.rows) {
            const qty = parseInt(row.quantity, 10);
            if (isNaN(qty) || qty <= 0) {
              isValid = false;
              errorMsg = `Jumlah tidak valid di blok ${block.type}.`;
              break;
            }
            if (block.type === 'Packing' && !row.sku) {
              isValid = false;
              errorMsg = `SKU kosong di blok ${block.type}.`;
              break;
            }
            if (!['Packing', 'Retur'].includes(block.type) && !row.description) {
              isValid = false;
              errorMsg = `Deskripsi kosong di blok ${block.type}.`;
              break;
            }
          }
          if (!isValid) break;
        }
        
        if (!isValid) {
          showNotification(errorMsg, true);
          return;
        } else {
          handleAssignMegaBatchTasks(selectedUsers, taskBlocks);
        }
      }
    }

    // --- Fungsi tambah baris Tugas Mandiri ---
    function handleAddRow(taskType) {
      let newItem;
      switch (taskType) {
        case 'packing': newItem = { sku: '', jumlah: '' }; break;
        case 'retur': newItem = { jenis: 'Input', jumlah: '' }; break;
        default: newItem = { tugas: '', keterangan: '' }; break;
      }
      const newItems = [...state.tasks[taskType], newItem];
      
      setState({ 
        tasks: { 
          ...state.tasks, 
          [taskType]: newItems 
        } 
      });
    }


    // --- Handler Aksi (Admin & User) ---
    
    // Fungsi untuk kirim BANYAK tugas (Admin)
    async function handleAssignMegaBatchTasks(users, blocks) {
      setState({ isLoading: true, loadingMessage: 'Memberi tugas...' });
      
      const cleanBlocks = blocks.map(block => ({
        type: block.type,
        rows: block.rows.map(row => {
          if (block.type === 'Packing') return { sku: row.sku, quantity: row.quantity };
          if (block.type === 'Retur') return { jenis: row.jenis, quantity: row.quantity };
          return { description: row.description, quantity: row.quantity };
        })
      }));

      const payload = {
        action: 'assignMegaBatchTasks', 
        username: state.userUsername,
        users: users, 
        taskBlocks: cleanBlocks 
      };
      
      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' },
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        setState({ isLoading: false });
        showNotification(result.message, false); 
        
        const newBlockId = crypto.randomUUID();
        const newRowId = crypto.randomUUID();
        setState({
          assignTaskState: {
            selectedUsers: [],
            taskBlocks: [
              { id: newBlockId, type: 'Packing', rows: [{id: newRowId, sku: '', quantity: 1}] }
            ]
          }
        });
        
        fetchAdminData();

      } catch (error) {
        showNotification(`Gagal memberi tugas: ${error.message}`, true);
        setState({ isLoading: false });
      }
    }
    
    // Fungsi untuk submit TUGAS HARIAN (dari tabel)
    async function handleSubmitTaskForApproval(taskId, hasilQty, targetQty) {
      setState({ isLoading: true, loadingMessage: 'Mengirim hasil...' });
      hideNotification();
      
      const payload = {
        action: 'submitTaskForApproval', 
        username: state.userUsername,
        taskId: taskId,
        hasilQty: hasilQty
      };

       try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' },
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        setState({ isLoading: false });
        showNotification(result.message, false); 
        
        delete state.userTaskResults[taskId];
        fetchUserTasks();

      } catch (error) {
        showNotification(`Gagal mengirim hasil: ${error.message}`, true);
        setState({ isLoading: false });
      }
    }

    // Kirim TUGAS MANDIRI untuk persetujuan
    async function handleSubmitMandiriTasks(taskType) {
      const items = state.tasks[taskType];
      
      const validItems = items.filter(item => {
         if (taskType === 'packing') return item.sku && (item.jumlah || 0) > 0;
         if (taskType === 'retur') return item.jenis && (item.jumlah || 0) > 0;
         return item.tugas && (item.keterangan || 0) > 0; 
      });

      if (validItems.length === 0) {
        showNotification("Tidak ada data valid untuk dikirim. Harap isi SKU/Jenis/Tugas dan Jumlah.", true);
        return;
      }
      
      setState({ isLoading: true, loadingMessage: 'Mengirim tugas mandiri...' });
      hideNotification();

      const payload = {
        action: 'submitMandiriTasks', 
        username: state.userUsername,
        taskType: taskType,
        items: validItems
      };

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' },
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        setState({ isLoading: false });
        showNotification(result.message, false); 
        
        setState({ 
          tasks: { 
            ...state.tasks, 
            [taskType]: [] 
          } 
        });

      } catch (error) {
        showNotification(`Gagal mengirim tugas mandiri: ${error.message}`, true);
        setState({ isLoading: false });
      }
    }

    // Admin menyetujui tugas (DIEDIT)
    async function handleApproveTask(taskId, hasilQty) { // <-- Terima 'hasilQty' baru
      setState({ isLoading: true, loadingMessage: 'Menyetujui tugas...' });
      hideNotification();

      const payload = {
        action: 'approveTask', 
        username: state.userUsername, 
        taskId: taskId,
        hasilQty: hasilQty // <-- Kirim 'hasilQty' yang sudah diedit
      };

       try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' },
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        setState({ isLoading: false });
        showNotification(result.message, false); 
        
        fetchTasksForApproval(); // Muat ulang data persetujuan
        fetchAdminData(); // Muat ulang data dashboard

      } catch (error) {
        showNotification(`Gagal menyetujui: ${error.message}`, true);
        setState({ isLoading: false });
      }
    }

    // Admin menolak tugas (FUNGSI BARU)
    async function handleRejectTask(taskId) {
      setState({ isLoading: true, loadingMessage: 'Menolak tugas...' });
      hideNotification();

      const payload = {
        action: 'rejectTask', // <-- Aksi baru
        username: state.userUsername, 
        taskId: taskId
      };

       try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' },
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        setState({ isLoading: false });
        showNotification(result.message, false); // "Tugas ditolak."
        
        fetchTasksForApproval(); // Muat ulang data persetujuan
        fetchAdminData(); // Muat ulang data dashboard

      } catch (error) {
        showNotification(`Gagal menolak: ${error.message}`, true);
        setState({ isLoading: false });
      }
    }


    // --- FUNGSI BARU: Tampilkan Modal Detail Tugas User ---
    function showUserDetailsModal(username) {
      const userData = state.adminUserStats[username];
      if (!userData) return;

      const modalTitle = getEl('user-task-modal-title');
      const modalBody = getEl('user-task-modal-body');
      
      modalTitle.textContent = `Detail Tugas: ${username}`;
      
      // Buat tabel untuk detail
      const statusColors = {
        'Pending': 'text-yellow-600',
        'Pending Approval': 'text-orange-600',
        'Completed': 'text-emerald-600',
        'Rejected': 'text-red-600' // <-- Status Baru
      };
      
      const taskRows = userData.tasks.map(task => {
        let statusHtml = '';
        const statusClass = statusColors[task.status] || 'text-gray-600';
        
        if (task.status === 'Pending Approval') {
          statusHtml = `
            <div class="flex items-center justify-center gap-1.5">
              <span class="font-medium ${statusClass}">Menunggu ACC</span>
              <button title="Buka Persetujuan" class="goto-approval-btn text-blue-500 hover:text-blue-700 p-0.5 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M181.66,133.66l-72,72a8,8,0,0,1-11.32-11.32L156.69,136H40a8,8,0,0,1,0-16H156.69L98.34,60.34a8,8,0,0,1,11.32-11.32l72,72A8,8,0,0,1,181.66,133.66Z"></path></svg>
              </button>
            </div>
          `;
        } else {
          let statusText = task.status;
          if(task.status === 'Pending') statusText = 'Pending';
          if(task.status === 'Completed') statusText = 'Selesai';
          if(task.status === 'Rejected') statusText = 'Ditolak'; // <-- Status Baru
          statusHtml = `<span class="font-medium ${statusClass}">${statusText}</span>`;
        }

        return `
          <tr class="border-b last:border-b-0">
            <td class="py-3 px-2 text-sm text-gray-700 align-top">
              <span class="font-medium">${task.type}</span>: ${task.description}
            </td>
            <td class="py-3 px-2 text-sm text-gray-600 text-center align-top">${task.target}</td>
            <td class="py-3 px-2 text-sm text-blue-700 font-bold text-center align-top">${task.hasil}</td>
            <td class="py-3 px-2 text-sm text-center align-top">
              ${statusHtml}
            </td>
          </tr>
        `;
      }).join('');

      modalBody.innerHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="py-2 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Tugas</th>
                <th class="py-2 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Target</th>
                <th class="py-2 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Hasil</th>
                <th class="py-2 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              ${taskRows}
            </tbody>
          </table>
        </div>
      `;
      
      getEl('user-task-modal').classList.remove('hidden');
    }
    
    // --- FUNGSI BARU: Sembunyikan Modal ---
    function hideUserDetailsModal() {
      const modal = getEl('user-task-modal');
      if (modal) {
        modal.classList.add('hidden');
        getEl('user-task-modal-body').innerHTML = ''; 
      }
    }

    // --- Fungsi Sidebar Mobile ---
    function openMobileSidebar() {
      getEl('mobile-sidebar-overlay').classList.remove('hidden');
      getEl('mobile-sidebar').classList.remove('-translate-x-full');
    }
    function closeMobileSidebar() {
      getEl('mobile-sidebar-overlay').classList.add('hidden');
      getEl('mobile-sidebar').classList.add('-translate-x-full');
    }

    // --- Inisialisasi Aplikasi ---
    document.addEventListener('DOMContentLoaded', () => {
      // Cek auto-login
      const savedUser = localStorage.getItem('dailyTaskUser');
      if (savedUser && GAS_WEB_APP_URL !== 'PASTE_URL_APLIKASI_WEB_ANDA_DI_SINI') {
        const { username, password } = JSON.parse(savedUser);
        getEl('login-username').value = username;
        getEl('login-password').value = password;
        handleLogin(new Event('submit'));
      } else {
        setState({ isLoading: false }); 
      }
      
      // Pasang Event Listener Global
      getEl('login-form').addEventListener('submit', handleLogin);
      setupPasswordToggle('toggle-login-password', 'login-password');
      
      // Aplikasi Utama
      getEl('sidebar-nav').addEventListener('click', handleSidebarClick);
      getEl('app-notification-close').addEventListener('click', hideNotification);

      getEl('user-menu-button').addEventListener('click', () => {
        getEl('logout-dropdown').classList.toggle('hidden');
      });
      getEl('logout-button').addEventListener('click', handleLogout);
      getEl('logout-button-mobile').addEventListener('click', handleLogout);
      getEl('sync-button').addEventListener('click', syncData);

      // Klik di luar dropdown untuk menutup
      document.addEventListener('click', (event) => {
        const profileMenu = getEl('user-profile-menu');
        const dropdown = getEl('logout-dropdown');
        if (profileMenu && !profileMenu.contains(event.target) && !dropdown.classList.contains('hidden')) {
          dropdown.classList.add('hidden');
        }
      });

      // Listener untuk modal (tutup dan navigasi)
      getEl('user-task-modal').addEventListener('click', (event) => {
        if (event.target.closest('#user-task-modal-close')) {
          hideUserDetailsModal();
        }
        if (event.target.id === 'user-task-modal') {
          hideUserDetailsModal();
        }
        if (event.target.closest('.goto-approval-btn')) {
          navigateToView('taskApproval');
        }
      });

      // Listener untuk Sidebar Mobile
      getEl('mobile-menu-button').addEventListener('click', openMobileSidebar);
      getEl('mobile-sidebar-close').addEventListener('click', closeMobileSidebar);
      getEl('mobile-sidebar-overlay').addEventListener('click', closeMobileSidebar);
      getEl('sidebar-nav-mobile').addEventListener('click', handleSidebarClick);
      
      // Listener untuk tombol dropdown TUGAS MANDIRI
      document.body.addEventListener('click', function(event) {
        const toggleButton = event.target.closest('#toggle-tugas-mandiri');
        if (toggleButton) {
          const parentNav = toggleButton.closest('nav, aside');
          if (!parentNav) return; 

          const submenu = parentNav.querySelector('#submenu-tugas-mandiri');
          const arrow = parentNav.querySelector('#arrow-tugas-mandiri');
          
          if (submenu && arrow) {
            submenu.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180'); 
          }
        }
      });
      
      // Listener untuk tombol "Kembali" di browser/HP
      window.addEventListener('popstate', (event) => {
        let viewToRender = state.userRole === 'admin' ? 'adminDashboard' : 'userDashboard';
        
        if (event.state && event.state.view) {
          viewToRender = event.state.view;
        } else {
          const hashView = window.location.hash.substring(1);
          if (hashView) {
            viewToRender = hashView;
          }
        }
        
        console.log('Popstate triggered, rendering view:', viewToRender);
        setState({ currentTaskView: viewToRender });
      });

      // Event Delegation untuk Konten Dinamis
      const viewContainer = getEl('view-container');
      viewContainer.addEventListener('click', handleViewContainerClick);
      viewContainer.addEventListener('input', handleViewContainerInput);
      viewContainer.addEventListener('change', handleViewContainerChange);
      viewContainer.addEventListener('submit', handleViewContainerSubmit); 
      
    });

  </script>
</body>
</html>
